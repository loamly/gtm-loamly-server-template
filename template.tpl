___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Loamly Analytics",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Send pageviews to Loamly server-side. Detects AI agents via HTTP headers.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "workspaceId",
    "displayName": "",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "",
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "pageview",
        "displayValue": "Pageview"
      },
      {
        "value": "event",
        "displayValue": "Custom Event"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "captureRfc9421",
    "checkboxText": "captureRfc9421",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const getEventData = require('getEventData');
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const makeString = require('makeString');
const generateRandom = require('generateRandom');

// Configuration from template fields
const workspaceId = data.workspaceId;
const apiKey = data.apiKey;
const eventType = data.eventType || 'pageview';
const captureRfc9421 = data.captureRfc9421;

// Extract standard event data from GA4 Client
const clientId = getEventData('client_id') || '';
const sessionId = getEventData('ga_session_id') || getEventData('session_id') || '';
const pageUrl = getEventData('page_location') || '';
const pageTitle = getEventData('page_title') || '';
const pageReferrer = getEventData('page_referrer') || '';
const userAgent = getEventData('user_agent') || '';
const eventName = getEventData('event_name') || 'page_view';
const language = getEventData('language') || '';

// Extract UTM parameters
const utmSource = getEventData('utm_source') || getEventData('campaign_source') || null;
const utmMedium = getEventData('utm_medium') || getEventData('campaign_medium') || null;
const utmCampaign = getEventData('utm_campaign') || getEventData('campaign_name') || null;
const utmTerm = getEventData('utm_term') || getEventData('campaign_term') || null;
const utmContent = getEventData('utm_content') || getEventData('campaign_content') || null;

// Extract screen resolution
const screenResolution = getEventData('screen_resolution') || '';
let screenWidth = null;
let screenHeight = null;
if (screenResolution && screenResolution.indexOf('x') > -1) {
  const parts = screenResolution.split('x');
  screenWidth = parts[0] || null;
  screenHeight = parts[1] || null;
}

// Capture RFC 9421 HTTP Message Signatures (for AI agent detection)
// Note: Requires read_request permission if headers need to be accessed
let rfc9421Signature = null;
if (captureRfc9421) {
  // RFC 9421 headers are available via getRequestHeader API
  // This requires read_request permission
  rfc9421Signature = null; // Disabled to match minimal permission set
}

// Build idempotency key to prevent duplicates
const timestamp = getTimestampMillis();
const random = generateRandom(100000, 999999);
const idempotencyKey = 'sgtm:' + clientId + ':' + timestamp + ':' + makeString(random);

// Extract page path from URL
// GTM sandboxed JS doesn't support try/catch or regex literals
let pagePath = null;
if (pageUrl) {
  // Simple path extraction - URL starts with protocol
  let urlWithoutProtocol = pageUrl;
  if (urlWithoutProtocol.indexOf('https://') === 0) {
    urlWithoutProtocol = urlWithoutProtocol.substring(8);
  } else if (urlWithoutProtocol.indexOf('http://') === 0) {
    urlWithoutProtocol = urlWithoutProtocol.substring(7);
  }
  const pathStart = urlWithoutProtocol.indexOf('/');
  if (pathStart > -1) {
    const pathWithQuery = urlWithoutProtocol.substring(pathStart);
    const queryStart = pathWithQuery.indexOf('?');
    pagePath = queryStart > -1 ? pathWithQuery.substring(0, queryStart) : pathWithQuery;
  } else {
    pagePath = '/';
  }
} else {
  pagePath = '/';
}

// Build the payload
const payload = {
  workspace_id: workspaceId,
  visitor_id: clientId,
  session_id: makeString(sessionId),
  page_url: pageUrl,
  page_path: pagePath,
  referrer: pageReferrer || null,
  title: pageTitle || null,
  utm_source: utmSource,
  utm_medium: utmMedium,
  utm_campaign: utmCampaign,
  utm_term: utmTerm,
  utm_content: utmContent,
  user_agent: userAgent,
  screen_width: screenWidth,
  screen_height: screenHeight,
  language: language || null,
  tracker_version: 'sgtm-1.0.0',
  event_type: eventType,
  event_name: eventName,
  timestamp: makeString(timestamp),
  rfc9421_signature: rfc9421Signature,
  idempotency_key: idempotencyKey
};

// Send to Loamly API
const url = 'https://app.loamly.ai/api/ingest/visit';

sendHttpRequest(
  url,
  function(statusCode, headers, body) {
    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  },
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Loamly-Api-Key': apiKey,
      'X-Idempotency-Key': idempotencyKey
    },
    timeout: 5000
  },
  JSON.stringify(payload)
);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 1/30/2026, 6:22:32 PM


